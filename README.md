#Qt2023

福州大学——机器人工程 gaoziya 

开源贴：
https://github.com/LunaLovegoodccio/2upr_rps.git
指导:wcy
(出处: 机械原理课设)


项目依赖：
* gcc/g++-11：升级方式：添加 ppa 升级
* Eigen3.4.0:提供矩阵和向量的线性代数操作的计算库 [编译安装]（https://github.com/eigenteam/eigen-git-mirror）
* Qt5.14.2:  "sudo apt-get install build-essential qt5-default"  或者  配置Qt Creator

# 简介
本项目适用于2upr_rps并联机器人上位机

功能：

-   z,a,b点动控制
-   示教模式控制
-   实时位置检测
-   回零
-   急停

# 代码框架

```txt
.
├── untitled.pro：qmake编译配置
├── README.md：本文档
├── main.cpp: 主函数
├── mainwindow.ui：ui界面
├── include
│   ├──  mainwindow.h: 界面配置文件
│   ├──  Global.h: 存放全局变量
│   ├──  calculate.h:计算类实现，实现正逆解解算
├── src
│   ├──  mainwindow.cpp
│   ├──  Global.cpp
│   ├──  calculate.cpp 

```

## 双通信协议

上位机和电控之间的数据交互是通过串口通信进行的。在这种通信方式下，需要定义合适的协议来实现数据的传输和有效性验证。

一种常见的实现方式是通过USB接入TTL模块或通过运算平台的4pin口直接接入电控的4pin UART口（无线烧录器）。这种方式能够实现稳定的数据传输，并可以通过电平变化来判断是否发生数据传输。

为了确保数据的有效性，数据包通常需要定义起始字节和结束字节，以标识一个完整的数据包的开始和结束。同时，还需要采用数据校验来验证数据的准确性。其中，一种简单的校验方式是使用首尾校验。

通过合适的协议和数据包结构以及校验方式，上位机和电控之间可以实现可靠的数据交互，并确保数据的准确性和完整性。

### 电控延迟

从电控发送电机转动指令，到电机实际转动的时间差，叫做电控延迟。根据电控的测试，这一延迟量非常微小，为个位数（ms）。

### Calculate
此calculate类代码部分涉及到对机器人运动学进行计算以及计算工作空间的判断。
在`calculate_Z`函数（正解）中，根据输入的运动参数`d1`、`d2`、`d3`，计算对应的`delta_q1`、`delta_q2`、`delta_q3`，并根据这些差值计算步进电机应给的脉冲数`Pulse`。然后根据运动参数的变化情况，计算速度`Speed`。最后将方向、速度、加速度和脉冲数添加到一个`QVector`中，作为交互协议的数据。
在`calculate_N`函数中，根据输入的坐标参数`z`、`a`、`b`，通过运动学逆解计算出对应的关节角度`q1`、`q2`、`q3`。同样，根据关节角度的差值计算步进电机应给的脉冲数`Pulse`，并根据运动参数的变化情况计算速度`Speed`。最后将方向、速度、加速度和脉冲数添加到一个`QVector`中，作为交互协议的数据。
在`calculateWorkspace`函数中，根据关节角度的范围限制和其他参数的限制，判断当前机器人是否在工作空间内。若在工作空间内，则返回`true`；否则，将一个值为"3"（急停指令）的`QByteArray`数据发送到串口并返回`false`。

以上是对代码的简要描述，目的是为了实现上位机和电控之间的数据交互和控制电机的运动。

### MainWindow
以上代码是一个基于Qt框架开发的机械原理的图形界面应用程序。该应用程序实现了与电控进行数据交互、控制电机进行运动的功能。

在主窗口类`MainWindow`的构造函数中，首先进行了一些界面的初始化操作，包括设置窗口标题、设置字体等。然后调用了`system_init`函数进行系统的初始化操作，包括打开串口、设置串口参数、连接信号和槽等。

在`system_init`函数中，设置了串口的参数，并打开了串口。然后通过定时器定时从串口读取数据。

在定时器的定时槽函数`timerTimeout`中，调用了`readSerialData`函数从串口读取数据。

在`readSerialData`函数中，读取串口返回的数据，并判断数据是否有效。如果数据有效，则将数据传递给槽函数`handleMotorPositionData`进行处理。

在`handleMotorPositionData`函数中，将电机的角度数据更新到界面上的相应控件中。

在发送数据的槽函数`handleDataSent`中，根据界面上输入的数据调用计算类`Calculate`的相关函数，计算出要发送到电控的数据，并通过串口发送数据。另外，在处理发送数据时候，它将每次需要发送的脉冲数据以30000为最大值进行划分且划分比例相等，以保证每次发送的脉冲数不超过电机所能承受的最大脉冲数，详细通信协议请见下位机文档。

在界面上的其他响应函数中，包括按钮的按下、释放等事件处理，通过调整相应的变量值，控制电机的运动。

整体来说，这段代码是一个简单的机器人控制应用程序，通过串口与电控进行数据交互，实现了对电机的控制和位置信息的获取，并展示在界面上。


### 轨迹规划
因为动平台的y始终为0,所以需要在动平台中心点再建立一个刀尖点，刀尖点距离动平台中心距离为e_tool
轨迹规划实现为末端刀尖点画一个轨迹圆，根据弧度制划分出圆弧上各点，使刀尖点移动到圆弧上各点，再根据刀尖点反推动平台z、a、b、另外动平台位姿可以反验刀尖点坐标，实现相互验证，相互转化，确保解算的正确性。


